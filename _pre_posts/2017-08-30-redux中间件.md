---
layout:     post
title:      "2017-08-30-redux中间件"
date:       "2017-08-30"
author:     "XuBaoshi"
header-img: "img/contact-bg.jpg"
---
# redux中间件 #
## 中间件原理 ##
> redux中间件可以理解为类似node的web框架（express、koa）所涉及到的中间件，express、koa中间件其实是一个个放置在请求（request）到响应（response）过程之间的需要执行的代码段，如：日志记录、请求处理、错误处理等。与express、koa相比较redux的中间件解决是不同的问题，但是在理论上都是采取的同一种解决方法。redux中间件都是从redux的dispatch方法着手而产生的第三方库。我们可以使用redux中间件做如：日志（redux-logger）、异步调用（redux-thunk、redux-promise等）、路由。下面以日志处理为例讲述redux中间件的原理。

> 使用redux的好处就是，每一个状态的变化都是透明的可以预测的，每次一个action被dispatched,新的状态便会被计算和保存。状态不能自己改变，需要dispatch指定的action状态才会发生响应的变化。如果希望在dispatch每一个action时能在控制台中看到触发的action的类型，同时也能看到触发后状态的变化。如何实现？下面有以下解决方案：

> reudx全局只有一个store（ps：示例中不使用react-redux） 
## 手动log ##

    class MessageListWrapper extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                messages: store.getState().messages
            };
            this.unSubscribeHandle = () => { };
        }
        render() {
            return (
                <MessageList messages={this.state.messages}
                    getMessages={this.getMessages}
                    addMessage={this.addMessage}
                    deleteMessage={this.deleteMessage}></MessageList>
            )

        }
        componentDidMount() {
            this.unSubscribeHandle = store.subscribe(() => {
                // 手动log state
                console.log('next state',store.getState())
                this.setState(store.getState())
            });
        }
        componentWillUnmount() {
            this.unSubscribeHandle();
        }
        addMessage() {
            console.log('dispatching',addMessageAction(new Date().getTime()));
            store.dispatch(addMessageAction(new Date().getTime()));

        }
        deleteMessage() {
            console.log('dispatching',deleteMessageAction());
            store.dispatch(deleteMessageAction());
        }
    }

手动log的方法确实可以实现，但每次写一个组件都要写log这显然不是很明智的选择。

## 函数包裹dispatch ## 
    
    const dispatchAndLog = (store, action) => {
        console.log('dispatching', action);
        store.dispatch(action);
        console.log('next state', store.getState());
    }
    class MessageListWrapper extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                messages: store.getState().messages
            };
            this.unSubscribeHandle = () => { };
        }
        render() {
            return (
                <MessageList messages={this.state.messages}
                    getMessages={this.getMessages}
                    addMessage={this.addMessage}
                    deleteMessage={this.deleteMessage}></MessageList>
            )

        }
        componentDidMount() {
            this.unSubscribeHandle = store.subscribe(() => {
                this.setState(store.getState())
            });
        }
        componentWillUnmount() {
            this.unSubscribeHandle();
        }
        addMessage() {
            dispatchAndLog(store, addMessageAction(new Date().getTime()));
        }
        deleteMessage() {
            dispatchAndLog(store, deleteMessageAction());
        }
    }

## 重构store.dispatch ## 

    const originDispatch = store.dispatch;
    store.dispatch = (action) => {
        console.log('dispatching', action);
        originDispatch(action);
        console.log('next state', store.getState());
    }

    class MessageListWrapper extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                messages: store.getState().messages
            };
            this.unSubscribeHandle = () => { };
        }
        render() {
            return (
                <MessageList messages={this.state.messages}
                    getMessages={this.getMessages}
                    addMessage={this.addMessage}
                    deleteMessage={this.deleteMessage}></MessageList>
            )

        }
        componentDidMount() {
            this.unSubscribeHandle = store.subscribe(() => {
                this.setState(store.getState())
            });
        }
        componentWillUnmount() {
            this.unSubscribeHandle();
        }
        addMessage() {
            store.dispatch(addMessageAction(new Date().getTime()));
        }
        deleteMessage() {
            store.dispatch(deleteMessageAction());
        }
    }

## 重构store.dispatch ## 
