---
layout: post
title: 'vue-cli webpack 配置信息分析（下）'
date: '2020-05-26'
author: 'XuBaoshi'
header-img: 'img/node-module.jpg'
---

# vue-cli webpack 配置信息分析（下）

## 使用 vue-cli3 生成 webpack 配置（default）

![/img/vue-cli/1.png](/img/vue-cli/1.png)

项目生成和完毕后，切换到项目目录，执行命令 `npx vue-cli-service inspect`, 生成的 webpack 信息如下：

[webpack 配置信息](/img/vue-cli/config.js)

## module

### noParse

vue-cli 配置：

```javascript
noParse: /^(vue|vue-router|vuex|vuex-router-sync)$/,
```

noParse 配置项可以让 webpack 忽略对部分从没有采用模块化的文件的递归解析与处理，可以提高构建性能， 没有采用模块化标准的库如（jquery）让 webpack 解析既耗时又没有意义。

noParse 支持正则表达式和函数

```javascript
// 使用正则表达式
noParse: /jquery|vue/

// 使用函数，从 Webpack 3.0.0 开始支持
noParse: (content) => {
  // content 代表一个模块的文件路径
  // 返回 true or false
  return /jquery|vue/.test(content)
}
```

注意：被忽略掉的文件里不应该包含 import 、 require 、 define 等模块化语句，不然会导致构建出的代码中包含无法在浏览器环境下执行的模块化语句。

### rules

rules 主要是用来配置模块的读取和解析规则，通常是用来配置 Loader。其类型是一个数组，数组中的每一项都是描述了如何去处理部分文件。

每一个 rule 大致都是使用以下方式：

1. 条件匹配 通过 `test`、`include`、`exclude` 三个配置项来命中匹配的文件
2. 应用规则 对选中后的文件通过 use 配置项来使用 Loader， 可以使用一个 loader 或者从后往前应用一组 Loader， 同时也可以分别给 loader 传入参数
3. 重置顺序 默认 use 内的 loader 是从后往前执行的， 但可以通过在 `enforce` 选项在最前或最后执行 loader

可以使用字符串或对象配置 loader。

字符串：

```javascript
{
  // 命中 JavaScript 文件
  test: /\.js$/,
  // 用 babel-loader 转换 JavaScript 文件
  // ?cacheDirectory 表示传给 babel-loader 的参数，用于缓存 babel 编译结果加快重新编译速度
  use: ['babel-loader?cacheDirectory'],
  // 只命中src目录里的js文件，加快 Webpack 搜索速度
  include: path.resolve(__dirname, 'src')
}
```

对象：

```javascript
{
  test: /\.js$/,
  use: [{
    loader:'babel-loader',
    options: {
      cacheDirectory: true
    }
  }],
  // 只命中src目录里的js文件，加快 Webpack 搜索速度
  include: path.resolve(__dirname, 'src')
}
```

#### vue

vue-cli 配置：

```javascript
{
  test: /\.vue$/,
  use: [
    /* config.module.rule('vue').use('cache-loader') */
    {
      loader: 'H:\\code\\own\\test\\node_modules\\cache-loader\\dist\\cjs.js',
      options: {
        cacheDirectory: 'H:\\code\\own\\test\\node_modules\\.cache\\vue-loader',
        cacheIdentifier: '5d7b93da'
      }
    },
    /* config.module.rule('vue').use('vue-loader') */
    {
      loader: 'H:\\code\\own\\test\\node_modules\\vue-loader\\lib\\index.js',
      options: {
        compilerOptions: {
          whitespace: 'condense'
        },
        cacheDirectory: 'H:\\code\\own\\test\\node_modules\\.cache\\vue-loader',
        cacheIdentifier: '5d7b93da'
      }
    }
  ]
}
```

上述配置中匹配到了后缀名为 vue 的文件，针对此类文件先后执行了 vue-loader 及 cache-loader。

提取 .vue 文件中的 script、style、html 模板代码，再分别交给对应的 loader 处理。loader 配置了 vue-loader 位置 。

其中 compilerOptions 的配置来源于 [vue-template-compiler](https://www.npmjs.com/package/vue-template-compiler) 插件，其中 `compilerOptions.whitespace = condense` 表示会尽可能减少标签之间的空白区域，这样会减少代码大小，提升编译性能。

cacheDirectory、cacheIdentifier 这两个选项需要同时配置并配合 cache-loader 使用开启文件系统的编译缓存。cacheDirectory 表示编译缓存存放位置，cacheIdentifier 表示缓存的标识符。

注：使用 vue-loader 不光要在 module.rules 配置引用 vue-loader， 同时需要引入 `vue-loader/lib/plugin`,同时在 plugins 内引入

```javascript
const VueLoaderPlugin = require('vue-loader/lib/plugin')

// ...
{
  plugins: [new VueLoaderPlugin()]
}
```

#### images

vue-cli 配置：

```javascript
{
  test: /\.(png|jpe?g|gif|webp)(\?.*)?$/,
  use: [
    /* config.module.rule('images').use('url-loader') */
    {
      loader: 'H:\\code\\own\\test\\node_modules\\url-loader\\dist\\cjs.js',
      options: {
        limit: 4096,
        fallback: {
          loader: 'H:\\code\\own\\test\\node_modules\\file-loader\\dist\\cjs.js',
          options: {
            name: 'img/[name].[hash:8].[ext]'
          }
        }
      }
    }
  ]
},
```

匹配 png、jpg、jpeg、webp 文件, 如果文件大小没有超过 4096b，使用 [url-loader](https://www.npmjs.com/package/url-loader) 将图片转换成 base64 的 URI。如果超过了 4096b 则使用 [file-loader](https://www.npmjs.com/package/url-loader) 放置在 `dist/img` 中，名称为 图片名称 + 8 位哈希值 + 文件后缀名。

#### svg

vue-cli 配置：

```javascript
{
  test: /\.(svg)(\?.*)?$/,
  use: [
    /* config.module.rule('svg').use('file-loader') */
    {
      loader: 'H:\\code\\own\\test\\node_modules\\file-loader\\dist\\cjs.js',
      options: {
        name: 'img/[name].[hash:8].[ext]'
      }
    }
  ]
}
```

svg 文件使用 file-loader 使用方式同上面的 images。

#### media

vue-cli 配置：

```javascript
{
  test: /\.(mp4|webm|ogg|mp3|wav|flac|aac)(\?.*)?$/,
  use: [
    /* config.module.rule('media').use('url-loader') */
    {
      loader: 'H:\\code\\own\\test\\node_modules\\url-loader\\dist\\cjs.js',
      options: {
        limit: 4096,
        fallback: {
          loader: 'H:\\code\\own\\test\\node_modules\\file-loader\\dist\\cjs.js',
          options: {
            name: 'media/[name].[hash:8].[ext]'
          }
        }
      }
    }
  ]
}
```

匹配 mp4、webm、ogg、mp3、wav、flac、aac 文件, 如果文件大小没有超过 4096b，使用 [url-loader](https://www.npmjs.com/package/url-loader) 将图片转换成 base64 的 URI。如果超过了 4096b 则使用 [file-loader](https://www.npmjs.com/package/url-loader) 放置在 `dist/img` 中，名称为 图片名称 + 8 位哈希值 + 文件后缀名。

#### fonts

vue-cli 配置：

```javascript
{
  test: /\.(woff2?|eot|ttf|otf)(\?.*)?$/i,
  use: [
    /* config.module.rule('fonts').use('url-loader') */
    {
      loader: 'H:\\code\\own\\test\\node_modules\\url-loader\\dist\\cjs.js',
      options: {
        limit: 4096,
        fallback: {
          loader: 'H:\\code\\own\\test\\node_modules\\file-loader\\dist\\cjs.js',
          options: {
            name: 'fonts/[name].[hash:8].[ext]'
          }
        }
      }
    }
  ]
}
```

处理方式同 images，打包后放置在 `dist/fonts`

#### pug

vue-cli 配置：

```javascript
{
  test: /\.pug$/,
  oneOf: [
    /* config.module.rule('pug').oneOf('pug-vue') */
    {
      resourceQuery: /vue/,
      use: [
        /* config.module.rule('pug').oneOf('pug-vue').use('pug-plain-loader') */
        {
          loader: 'pug-plain-loader'
        }
      ]
    },
    /* config.module.rule('pug').oneOf('pug-template') */
    {
      use: [
        /* config.module.rule('pug').oneOf('pug-template').use('raw') */
        {
          loader: 'raw-loader'
        },
        /* config.module.rule('pug').oneOf('pug-template').use('pug-plain-loader') */
        {
          loader: 'pug-plain-loader'
        }
      ]
    }
  ]
}
```

#### css

#### postcss

#### scss

#### sass

#### less

#### stylus

#### js

#### eslint

## optimization

## plugins
